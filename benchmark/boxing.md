# Microbenchmark for boxing

## Objective

* Measure the cost of pushing operator’s arguments into torch::jit::Stack as IValue objects (a.k.a boxing).

## Approach 1 - measure on Python eager call path

### Measured Code

```
template<class... Args>
static torch::jit::Stack boxArgs(Args... args) {
  torch::jit::Stack stack;
  stack.reserve(sizeof...(Args));
  torch::jit::push(stack, std::forward<Args>(args)...);
  return stack;
}
```

### Overhead Injection

Added overhead to python_torch_functions.cpp call path. Repeat boxArgs() **N** times with **K** times of # args:

```
// aten::add.out(Tensor self, Tensor other, *, Scalar alpha=1, Tensor(a!) out) -> Tensor(a!)
auto dispatch_add_out = [](Tensor out, const Tensor & self, const Tensor & other, Scalar alpha) -> Tensor {
    pybind11::gil_scoped_release no_gil;
    for (int i = 0; i < N; i++) {
      auto args = boxArgs(out, self, other, alpha,
                          out, self, other, alpha,
                          out, self, other, alpha,
                          out, self, other, alpha);
    }
    return at::add_out(out, self, other, alpha);
};
return wrap(dispatch_add_out(_r.tensor(3), _r.tensor(0), _r.tensor(1), _r.scalar(2)));

```

### Python Test Driver

Measure average runtime of 10,000 outplace simple add:

```
def report(name, start, count):
    duration = time.time() - start
    print("{:>35}{:>25.2f}{:>25.2f}".format(
        name, count / duration, duration / count * 1e9))


def benchmark(name, fn, count):
    fn()  # warm up
    start = time.time()
    fn()
    report(name, start, count)


def add_s1_nograd_outplace(count):
    with torch.no_grad():
        a = torch.ones(1, requires_grad=False)
        b = torch.ones(1, requires_grad=False)
        c = torch.empty(1, requires_grad=False)

        def run():
            nonlocal a, b, c
            for _ in range(count):
                torch.add(a, b, out=c)

        benchmark("add_s1_nograd_outplace", run, count)

add_s1_nograd_outplace(10000)
```

### Measures

* Baseline (without boxing): 1824±99 ns
* Python baseline runtime CI is at ~100ns level, which is similar as the boxing runtime we try to measure. So C++ loop is a must to reduce CI - but will it affect the characteristics of the execution (CPU cache miss, heap allocation cost, etc)?
* Tweaking C++/Python iteration count, the per-argument boxing cost varies: 30.0±0.4ns, 35.0±6.1ns, 39.3±37.3ns
* Fewer # of C++ loops resulted in slightly larger runtime with larger CI - is it just noise? does it reflect real cost increase on cold cache?

|   |Baseline   |Baseline   |Baseline   |No Push    |   |   |   |   |   |
|---    |---    |---    |---    |---    |---    |---    |---    |---    |---    |
|Python Iter #  |1,000,000  |5,000,000  |100,000,000    |10,000 |1,000,000  |5,000,000  |1,000,000  |1,000,000  |10,000 |
|N (C++ Iter #) |0  |0  |0  |1,000  |1  |1  |10 |100    |1,000  |
|K (Args # = 4 x K) |0  |0  |0  |0  |1  |1  |1  |1  |1  |
|20 Runs    |1,685.90   |1,592.45   |1,718.52   |4,604.96   |1,838.36   |1,875.69   |2,903.98   |13,462.67  |121,604.54 |
|   |1,608.05   |2,615.43   |2,037.89   |4,433.47   |1,821.27   |2,216.40   |2,915.96   |13,337.99  |121,580.55 |
|   |1,529.07   |1,650.10   |1,675.54   |4,540.28   |1,849.79   |1,766.09   |2,922.50   |13,353.50  |120,465.80 |
|   |1,507.98   |1,663.54   |1,843.69   |5,455.61   |1,834.24   |1,846.12   |3,091.85   |13,539.94  |129,287.55 |
|   |1,559.28   |1,703.08   |1,666.52   |5,629.63   |1,897.94   |1,875.30   |2,847.02   |13,279.35  |121,447.30 |
|   |2,597.66   |1,692.91   |1,690.57   |4,556.11   |1,770.04   |1,814.78   |4,118.82   |13,441.14  |120,825.17 |
|   |1,592.04   |1,725.77   |1,923.44   |5,073.86   |1,849.78   |2,651.51   |4,783.30   |13,850.66  |122,852.59 |
|   |1,607.70   |2,531.00   |1,595.05   |4,688.12   |1,891.46   |1,802.00   |3,105.64   |13,901.74  |121,451.78 |
|   |1,694.12   |1,671.89   |2,152.45   |4,769.68   |3,154.71   |1,881.43   |4,664.84   |15,168.96  |119,804.91 |
|   |1,625.40   |1,834.46   |1,730.64   |4,960.37   |1,772.92   |1,774.68   |3,318.66   |13,268.46  |118,091.06 |
|   |1,625.48   |1,688.85   |1,561.93   |4,518.58   |1,890.29   |3,183.27   |3,011.06   |13,637.77  |121,063.21 |
|   |1,790.06   |1,670.49   |2,245.06   |4,658.44   |1,875.18   |1,887.67   |3,049.13   |13,416.54  |132,892.89 |
|   |1,651.04   |1,660.59   |2,045.85   |4,806.71   |1,845.75   |1,821.68   |2,979.76   |13,656.56  |121,663.59 |
|   |1,506.56   |1,639.84   |1,656.45   |4,545.88   |1,925.92   |2,035.41   |2,941.99   |13,470.07  |127,690.17 |
|   |1,642.10   |1,540.44   |2,031.29   |4,602.79   |1,838.87   |1,879.00   |2,999.71   |13,574.64  |120,762.35 |
|   |1,576.44   |1,638.72   |1,939.83   |4,953.10   |1,878.33   |1,794.57   |2,926.52   |13,432.98  |120,987.92 |
|   |2,601.22   |1,564.62   |1,590.12   |4,933.91   |1,852.51   |2,059.70   |2,944.28   |14,886.64  |122,141.50 |
|   |1,658.50   |1,576.06   |1,572.66   |5,141.69   |1,940.55   |1,793.67   |2,992.01   |13,417.94  |118,533.04 |
|   |1,623.94   |1,578.80   |2,239.46   |4,978.82   |1,901.11   |1,832.90   |3,000.69   |13,597.68  |114,900.23 |
|   |1,793.42   |1,639.53   |1,564.42   |5,807.69   |1,882.76   |1,836.98   |2,989.57   |14,239.96  |123,254.82 |
|   |   |   |   |   |   |   |   |   |   |
|Average    |1,723.80   |1,743.93   |1,824.07   |4,882.99   |1,925.59   |1,981.44   |3,225.36   |13,696.76  |122,065.05 |
|(Average-Base)/N   |   |   |   |3.06   |101.52 |157.37 |140.13 |118.73 |120.24 |
|(Average-Base)/N/K/4   |   |   |   |   |25.38  |39.34  |35.03  |29.68  |30.06  |
|   |   |   |   |   |   |   |   |   |   |
|STDEV. P   |301.27 |283.93 |227.85 |374.31 |285.17 |340.25 |564.34 |500.00 |3,854.36   |
|95% Confidence |132.04 |124.44 |99.86  |164.05 |124.98 |149.12 |247.33 |219.13 |1,689.22   |
|95% Confidence/N   |   |   |   |0.16   |124.98 |149.12 |24.73  |2.19   |1.69   |
|95% Confidence/N/K/4   |   |   |   |   |31.24  |37.28  |6.18   |0.55   |0.42   |

* Increasing K, the cost of boxing 4xK args grows slower than O(K) - (boxing the same set of 4 args won’t duplicate the IValue conversion cost?)
    * Boxing 4 x 2 args: 25.0±0.6ns
    * Boxing 4 x 4 args: 22.6±0.2ns
    * Boxing 4 x 8 args: 18.5±0.2ns

|   |Baseline   |   |   |   |   |   |   |   |   |
|---    |---    |---    |---    |---    |---    |---    |---    |---    |---    |
|Python Iter #  |100,000,000    |10,000 |10,000 |10,000 |10,000 |10,000 |10,000 |10,000 |10,000 |
|N (C++ Iter #) |0  |500    |1,000  |250    |500    |1,000  |250    |500    |1,000  |
|K (Args # = 4 x K) |0  |2  |2  |4  |4  |4  |8  |8  |8  |
|20 Runs    |1,718.52   |101,205.33 |216,864.90 |92,681.81  |193,061.76 |377,376.32 |146,215.30 |307,500.27 |570,883.46 |
|   |2,037.89   |100,744.63 |217,657.04 |89,084.08  |181,104.28 |370,059.51 |147,703.67 |291,738.58 |599,444.10 |
|   |1,675.54   |104,358.84 |191,339.21 |93,828.23  |183,031.51 |358,713.08 |147,640.18 |296,945.57 |583,511.14 |
|   |1,843.69   |101,166.68 |211,442.33 |90,628.19  |182,508.78 |357,460.90 |150,740.10 |292,638.21 |580,121.90 |
|   |1,666.52   |102,079.58 |211,005.33 |89,165.19  |179,884.20 |359,027.86 |146,146.01 |306,795.76 |582,009.10 |
|   |1,690.57   |105,867.62 |215,778.61 |92,150.40  |181,789.28 |358,219.17 |153,577.49 |295,067.05 |602,257.70 |
|   |1,923.44   |99,710.66  |192,068.89 |91,422.27  |179,256.68 |354,714.42 |148,395.68 |291,462.02 |580,203.29 |
|   |1,595.05   |105,386.76 |204,861.33 |93,462.32  |180,603.84 |384,873.15 |142,869.52 |292,544.89 |582,940.82 |
|   |2,152.45   |98,798.04  |213,093.64 |92,068.05  |188,368.01 |362,113.05 |145,935.51 |295,814.66 |590,745.04 |
|   |1,730.64   |109,264.76 |208,809.83 |91,479.66  |180,058.05 |358,659.84 |147,372.79 |299,186.44 |601,494.50 |
|   |1,561.93   |101,085.35 |185,247.97 |97,067.50  |182,132.10 |361,754.20 |152,174.23 |292,396.00 |598,616.17 |
|   |2,245.06   |95,146.20  |193,241.86 |98,930.53  |190,459.56 |361,783.08 |158,980.56 |297,693.42 |617,498.54 |
|   |2,045.85   |98,658.06  |191,730.38 |88,566.52  |180,453.59 |357,218.93 |146,405.24 |298,683.05 |590,339.21 |
|   |1,656.45   |97,315.31  |199,093.32 |90,017.01  |183,279.82 |358,354.69 |153,656.39 |317,325.35 |625,734.76 |
|   |2,031.29   |99,178.46  |216,302.80 |91,018.08  |183,935.21 |360,726.67 |148,418.19 |285,243.13 |593,500.14 |
|   |1,939.83   |104,862.93 |188,969.18 |95,373.15  |178,979.25 |369,188.93 |144,033.50 |291,709.73 |588,892.08 |
|   |1,590.12   |103,972.60 |190,607.83 |91,156.36  |177,080.58 |364,802.96 |145,958.50 |298,725.32 |588,223.96 |
|   |1,572.66   |103,601.38 |192,322.13 |89,619.68  |182,727.03 |371,246.50 |146,969.22 |294,828.49 |607,363.44 |
|   |2,239.46   |103,340.34 |194,856.33 |87,127.52  |183,707.59 |358,832.38 |151,757.72 |289,967.92 |605,626.56 |
|   |1,564.42   |100,143.91 |208,517.65 |89,872.93  |179,944.94 |360,882.95 |148,445.30 |294,931.75 |591,445.23 |
|   |   |   |   |   |   |   |   |   |   |
|Average    |1,824.07   |101,794.37 |202,190.53 |91,735.97  |182,618.30 |363,300.43 |148,669.76 |296,559.88 |594,042.56 |
|(Average-Base)/N   |   |199.94 |200.37 |359.65 |361.59 |361.48 |587.38 |589.47 |592.22 |
|(Average-Base)/N/K/4   |   |24.99  |25.05  |22.48  |22.60  |22.59  |18.36  |18.42  |18.51  |
|   |   |   |   |   |   |   |   |   |   |
|STDEV. P   |227.85 |3,248.89   |10,904.06  |2,828.62   |3,843.89   |7,428.74   |3,712.21   |6,981.22   |13,099.54  |
|95% Confidence |99.86  |1,423.86   |4,778.83   |1,239.68   |1,684.63   |3,255.73   |1,626.92   |3,059.60   |5,741.02   |
|95% Confidence/N   |   |2.85   |4.78   |4.96   |3.37   |3.26   |6.51   |6.12   |5.74   |
|95% Confidence/N/K/4   |   |0.36   |0.60   |0.31   |0.21   |0.20   |0.20   |0.19   |0.18   |

## Approach 2 - measure on C++ call path

### Overhead Injection

```
void add_s1_nograd_outplace_novar_boxing_4x1(int count) {
  torch::NoGradGuard nograd_guard;
  torch::AutoNonVariableTypeMode non_variable_type_guard;
  auto a = torch::ones({1});
  auto b = torch::ones({1});
  auto c = torch::empty({1});

  BENCHMARK("add_s1_nograd_outplace_novar_boxing_4x1", count, {
    boxArgs(a, b, c, 1.0);
    at::add_out(c, a, b);
  })
}

int main() {
  add_s1_nograd_outplace_novar(10000000);
  add_s1_nograd_outplace_novar_boxing_4x1(10000000);
  // ...
}
```

### Measures

* Baseline (without boxing): 702±17.2ns
* The cost of boxing N args still grows slower than O(N) - regardless of boxing K sets of same 4 args or 4xK unique args.
    * Boxing a single argument costs 36±0.5ns.
    * As # of arguments increasing, the per-argument boxing cost decreases from 27±0.5ns to 21±0.8ns.

* C++ runtime CI is much narrower, so it seems ok not to repeat boxing logic inside C++ when args # is large.

|   |Baseline   |   |   |   |   |   |   |   |   |   |
|---    |---    |---    |---    |---    |---    |---    |---    |---    |---    |---    |
|N  |0  |100    |10 |1  |1  |1  |1  |1  |1  |1  |
|Args # |0  |1  |2  |4  |4  |4  |4  |8  |16 |32 |
|K  |0  |1  |1  |1  |2  |4  |8  |1  |1  |1  |
|20 Runs    |685.43 |4,658.83   |1,256.42   |776.30 |869.98 |1,016.35   |1,306.20   |923.21 |1,061.53   |1,368.38   |
|   |703.88 |4,575.99   |1,248.36   |762.34 |861.24 |1,001.51   |1,274.70   |857.53 |1,003.88   |1,309.30   |
|   |681.27 |4,486.97   |1,271.77   |771.30 |883.19 |998.42 |1,278.53   |859.43 |1,014.33   |1,316.33   |
|   |716.43 |4,293.79   |1,262.23   |864.51 |1,020.36   |1,038.43   |1,363.15   |934.48 |1,075.78   |1,463.75   |
|   |660.21 |4,408.51   |1,258.61   |781.05 |896.10 |1,084.87   |1,402.16   |892.53 |1,026.30   |1,391.89   |
|   |686.64 |4,330.56   |1,275.88   |835.60 |901.48 |1,070.86   |1,341.18   |905.71 |1,144.85   |1,412.88   |
|   |684.01 |4,267.55   |1,216.56   |810.19 |944.23 |1,089.98   |1,379.20   |891.86 |1,043.74   |1,336.07   |
|   |725.76 |4,324.88   |1,270.47   |835.77 |855.69 |1,011.65   |1,268.13   |864.58 |1,041.26   |1,297.68   |
|   |666.48 |4,328.96   |1,265.97   |780.29 |915.48 |1,047.38   |1,469.99   |1,039.32   |1,216.07   |1,452.57   |
|   |749.80 |4,343.64   |1,210.02   |816.15 |853.99 |1,010.20   |1,291.24   |852.86 |1,014.52   |1,292.92   |
|   |807.93 |4,564.61   |1,225.12   |883.92 |883.69 |1,041.31   |1,468.73   |1,072.20   |1,204.98   |1,492.73   |
|   |689.28 |4,336.45   |1,279.37   |812.52 |898.26 |1,079.21   |1,347.03   |886.83 |1,071.40   |1,307.38   |
|   |767.31 |4,345.94   |1,260.36   |790.33 |855.51 |1,064.84   |1,335.98   |884.58 |1,064.21   |1,359.09   |
|   |664.01 |4,208.77   |1,237.46   |790.41 |933.81 |1,112.74   |1,407.18   |924.61 |1,093.80   |1,413.83   |
|   |755.67 |4,234.17   |1,289.34   |856.04 |903.23 |1,065.18   |1,324.08   |882.55 |1,032.19   |1,425.55   |
|   |694.34 |4,281.08   |1,244.69   |810.69 |902.09 |1,025.80   |1,318.53   |875.38 |1,048.12   |1,355.50   |
|   |703.22 |4,270.42   |1,267.41   |831.69 |895.09 |1,061.79   |1,461.47   |940.17 |1,071.81   |1,454.45   |
|   |672.04 |4,233.68   |1,254.66   |775.56 |876.04 |1,027.89   |1,305.44   |937.11 |1,046.76   |1,306.89   |
|   |668.77 |4,477.79   |1,288.60   |790.29 |848.82 |1,002.64   |1,305.30   |851.61 |1,009.29   |1,297.18   |
|   |662.40 |4,294.19   |1,237.55   |766.75 |904.57 |1,100.33   |1,309.81   |925.00 |1,057.64   |1,392.23   |
|   |   |   |   |   |   |   |   |   |   |   |
|Average    |702.24 |4,363.34   |1,256.04   |807.09 |895.14 |1,047.57   |1,347.90   |910.08 |1,067.12   |1,372.33   |
|(Average-Base)/N   |   |36.61  |55.38  |104.84 |192.90 |345.33 |645.66 |207.83 |364.88 |670.09 |
|(Average-Base)/N/K/Args    |   |36.61  |27.69  |26.21  |24.11  |21.58  |20.18  |25.98  |22.80  |20.94  |
|   |   |   |   |   |   |   |   |   |   |   |
|STDEV. P   |39.33  |122.52 |21.64  |33.96  |38.50  |34.48  |62.55  |56.45  |57.43  |62.43  |
|95% Confidence |17.24  |53.69  |9.48   |14.88  |16.87  |15.11  |27.41  |24.74  |25.17  |27.36  |
|95% Confidence/N   |   |0.54   |0.95   |14.88  |16.87  |15.11  |27.41  |24.74  |25.17  |27.36  |
|95% Confidence/N/K/Args    |   |0.54   |0.47   |3.72   |2.11   |0.94   |0.86   |3.09   |1.57   |0.85   |

